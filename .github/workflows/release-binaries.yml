name: Release Binaries

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  # Build binaries using reusable workflow
  build-binaries:
    uses: ./.github/workflows/build-binaries.yml
    with:
      artifact_prefix: "release"
      upload_artifacts: true

  # Create GitHub release with all artifacts
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-binaries]
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create checksums file
        run: |
          cd artifacts
          cat */*.sha256 > ../checksums.txt
          cd ..
          echo "Checksums:"
          cat checksums.txt

      - name: Determine tag name
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag_name, '-') }}
          files: |
            artifacts/*/release-*.tar.gz
            artifacts/*/release-*.zip
            checksums.txt
          body: |
            ## C# Analyzer Provider ${{ steps.tag.outputs.tag_name }}

            ### Installation

            Download the appropriate binary for your platform:

            #### Linux
            - `c-sharp-analyzer-provider-linux-x86_64.tar.gz` - Linux x86_64 (AMD64)
            - `c-sharp-analyzer-provider-linux-aarch64.tar.gz` - Linux ARM64

            #### macOS
            - `c-sharp-analyzer-provider-darwin-x86_64.tar.gz` - macOS Intel
            - `c-sharp-analyzer-provider-darwin-aarch64.tar.gz` - macOS Apple Silicon (M1/M2)

            #### Windows
            - `c-sharp-analyzer-provider-windows-x86_64.zip` - Windows x86_64 (AMD64)
            - `c-sharp-analyzer-provider-windows-aarch64.zip` - Windows ARM64

            ### Verification

            All binaries include SHA256 checksums. Verify your download:

            ```bash
            # Linux/macOS
            sha256sum -c c-sharp-analyzer-provider-<platform>.tar.gz.sha256

            # Windows (PowerShell)
            Get-FileHash c-sharp-analyzer-provider-<platform>.zip -Algorithm SHA256
            ```

            ### Usage

            ```bash
            # Extract (Linux/macOS)
            tar xzf c-sharp-analyzer-provider-<platform>.tar.gz

            # Extract (Windows)
            # Use Windows Explorer or PowerShell Expand-Archive

            # Run
            ./c-sharp-analyzer-provider-cli --port 9000 --name c-sharp
            ```

            ### Changes

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ steps.tag.outputs.tag_name }}/CHANGELOG.md) for details.

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
